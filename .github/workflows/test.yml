name: Tests

on:
  push:
    branches:
      - main
    paths-ignore:
      - "README.md"
  pull_request:
    branches:
      - main
    paths-ignore:
      - "README.md"

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: "go.mod"
          cache: true
      - name: Build
        run: go build -v ./...
      - name: Run go vet
        run: go vet ./...
      - name: Run linters
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
        with:
          version: latest

  test:
    name: Terraform Provider Acceptance Tests
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 130
    strategy:
      fail-fast: false
      matrix:
        terraform:
          - "1.0.*"
          - "1.1.*"
          - "1.2.*"
          - "1.3.*"
          - "1.4.*"
          - "1.5.*"
          - "1.6.*"
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: "go.mod"
          cache: true
      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ matrix.terraform }}
          terraform_wrapper: false
      - run: go mod download
      - name: Start SSH server container
        run: |
          docker run -d --name ssh-server \
            -p 2222:2222 \
            -e PUID=1000 \
            -e PGID=1000 \
            -e TZ=Etc/UTC \
            -e PASSWORD_ACCESS=true \
            -e USER_PASSWORD=testpass \
            -e USER_NAME=testuser \
            linuxserver/openssh-server:latest
          echo "Waiting for SSH server to start..."
          sleep 3
          echo "Configuring SSH server for higher connection limits..."
          docker exec ssh-server sh -c 'echo "MaxStartups 100:30:200" >> /config/sshd/sshd_config'
          docker exec ssh-server sh -c 'echo "MaxSessions 100" >> /config/sshd/sshd_config'
          docker exec ssh-server pkill -HUP sshd || true
          echo "SSH server configured and ready for testing"
          sleep 2
      - name: Run acceptance tests
        env:
          TF_ACC: "1"
          TEST_SSH_HOST: "localhost"
          TEST_SSH_PORT: "2222"
          TEST_SSH_USER: "testuser"
          TEST_SSH_PASSWORD: "testpass"
        run: go test -v -cover -timeout 120m -parallel=1 ./...
        timeout-minutes: 125
      - name: Stop SSH server
        if: always()
        run: docker stop ssh-server && docker rm ssh-server

  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Install Just
        uses: extractions/setup-just@v2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: "go.mod"
          cache: true
      - run: just generate
      - name: git diff
        run: |
          git diff --compact-summary --exit-code || \
            (echo; echo "Unexpected difference in directories after code generation. Run 'just generate' command and commit."; exit 1)
